KERNEL_ARCH_SRC_DIR := $(GET_LOCAL_DIR)
KERNEL_ARCH_OUT_DIR := $(KERNEL_OUT_DIR)/arch
$(shell mkdir -p $(KERNEL_ARCH_OUT_DIR))

KERNEL_ARCH_I386_O_FILES += \
	atomic_init.o \
	atomic.o \
	arch_i386.o \
	processor.o \
	vm.o \
	vm_transmap.o \
	interrupt.o \
	int_entry.o

KERNEL_ARCH_I386_O_FILES := $(addprefix $(KERNEL_ARCH_OUT_DIR)/,$(KERNEL_ARCH_I386_O_FILES))

KERNEL_O_FILES += $(KERNEL_ARCH_I386_O_FILES)

$(KERNEL): $(KERNEL_ARCH_SRC_DIR)/kernel.ld $(KERNEL_O_FILES) $(LIBSTRING) $(LIBPHLOX)
	$(LD) $(GLOBAL_LDFLAGS) -L$(LIBGCC_PATH) -dN -script=$(KERNEL_ARCH_SRC_DIR)/kernel.ld -o $(KERNEL) $(KERNEL_O_FILES) $(LIBPHLOX) $(LIBSTRING) $(LIBGCC)

$(KERNEL_ARCH_OUT_DIR)/%.o: $(KERNEL_ARCH_SRC_DIR)/%.c
	$(CC) -c $< $(GLOBAL_CFLAGS) $(KERNEL_CFLAGS) $(INCLUDES) -o $@

$(KERNEL_ARCH_OUT_DIR)/%.o: $(KERNEL_ARCH_SRC_DIR)/%.S
	$(CC) -c $< $(GLOBAL_ASFLAGS) $(GLOBAL_CFLAGS) $(KERNEL_CFLAGS) $(INCLUDES) -o $@
